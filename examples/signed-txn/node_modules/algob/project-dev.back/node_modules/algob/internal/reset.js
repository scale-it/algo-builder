"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.resetBuilderContext = void 0;
/**
 * This function resets the algob context.
 *
 * This doesn't unload any loaded Algob plugin, so those have to be unloaded
 * manually with `unloadModule`.
 */
const context_1 = require("./context");
const project_structure_1 = require("./core/project-structure");
// import { globSync } from "./util/glob";
function resetBuilderContext() {
    if (context_1.BuilderContext.isCreated()) {
        const ctx = context_1.BuilderContext.getBuilderContext();
        const globalAsAny = global; // eslint-disable-line @typescript-eslint/no-explicit-any
        if (ctx.environment !== undefined) {
            for (const key of Object.keys(ctx.environment)) {
                globalAsAny[key] = undefined;
            }
            // unload config file too.
            if (ctx.environment.config.paths != null) {
                unloadModule(ctx.environment.config.paths.configFile);
            }
        }
        else {
            // We may get here if loading the config has thrown, so be unload it
            let configPath;
            try {
                configPath = project_structure_1.getUserConfigPath();
            }
            catch (error) {
                // We weren't in a algob project
            }
            if (configPath !== undefined) {
                unloadModule(configPath);
            }
        }
        context_1.BuilderContext.deleteBuilderContext();
    }
    // Unload all the algob's entry-points.
    unloadModule("../register");
    unloadModule("./cli/cli");
    unloadModule("./lib/lib");
}
exports.resetBuilderContext = resetBuilderContext;
function unloadModule(path) {
    try {
        delete require.cache[require.resolve(path)];
    }
    catch (err) {
        // module wasn't loaded
    }
}
//# sourceMappingURL=reset.js.map